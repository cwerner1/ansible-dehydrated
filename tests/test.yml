---


- hosts: all
  remote_user: root
  tasks:
  - name: Install nginx-light as test server
    apt:
      package: "nginx-light"
      state: present
  # etckeeper setup
  - apt: package=etckeeper state=present
  - set_fact:
      revision: "{{ lookup('pipe', 'cd \"%s\" ; git rev-parse HEAD' % playbook_dir) }}"
  # Ubuntu sucks
  - lineinfile:
      dest: "/etc/etckeeper/etckeeper.conf"
      regexp: '^VCS="[^git][a-z]*"'
      state: absent
    when: ansible_distribution == 'Ubuntu'
  - lineinfile:
      dest: "/etc/etckeeper/etckeeper.conf"
      regexp: "^#?VCS=\"git\""
      line: "VCS=\"git\""
    when: ansible_distribution == 'Ubuntu'
  - shell: "etckeeper init && etckeeper commit initial"
    when: ansible_distribution == 'Ubuntu'


- hosts: all
  remote_user: root
  vars_files:
    - test_vars.yml
  roles:
    - letsencryptsh


- hosts: all
  remote_user: root
  vars_files:
    - test_vars.yml
  tasks:
  - name: run weekly cron script to initial create all certificates
    shell: /etc/cron.weekly/letsencrypt-sh
    changed_when: false
