---


- hosts: all
  remote_user: root
  tasks:
  - name: Update repositories cache
    apt: update_cache=yes
    changed_when: false

- hosts: all
  remote_user: root
  tasks:
  - name: Install nginx-light as test server
    apt:
      package: "nginx-light"
      state: present
  # etckeeper setup
  - apt: package=etckeeper state=present
  - set_fact:
      revision: "{{ lookup('pipe', 'cd \"%s\" ; git rev-parse HEAD' % playbook_dir) }}"
  # Ubuntu sucks
  - lineinfile:
      dest: "/etc/etckeeper/etckeeper.conf"
      regexp: '^VCS="[^git][a-z]*"'
      state: absent
    when: ansible_distribution == 'Ubuntu'
  - lineinfile:
      dest: "/etc/etckeeper/etckeeper.conf"
      regexp: "^#?VCS=\"git\""
      line: "VCS=\"git\""
    when: ansible_distribution == 'Ubuntu'
  - shell: |
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"
        etckeeper uninit -f
        etckeeper init && etckeeper commit initial > /dev/null
    args:
      creates: /etc/.git


# run role under test
- hosts: all
  remote_user: root
  roles:
    - martin-v.dehydrated
